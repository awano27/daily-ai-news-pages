name: Deploy AI News to GitHub Pages

on:
  push:
    branches: [ main ]
  schedule:
    # Run daily at 7:00 JST (22:00 UTC)
    - cron: '0 22 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt || pip install feedparser pyyaml deep-translator==1.11.4 beautifulsoup4 requests google-generativeai>=0.3.0 python-dateutil>=2.8.0

    - name: Set environment variables
      run: |
        echo "TRANSLATE_TO_JA=1" >> $GITHUB_ENV
        echo "TRANSLATE_ENGINE=google" >> $GITHUB_ENV
        echo "HOURS_LOOKBACK=48" >> $GITHUB_ENV
        echo "MAX_ITEMS_PER_CATEGORY=25" >> $GITHUB_ENV
        echo "X_POSTS_CSV=https://docs.google.com/spreadsheets/d/1uuLKCLIJw--a1vCcO6UGxSpBiLTtN8uGl2cdMb6wcfg/export?format=csv&gid=0" >> $GITHUB_ENV

    - name: Build AI News Site
      timeout-minutes: 10
      run: |
        echo "ğŸ”¨ Building AI News site with enhanced ranking..."
        python build_simple_ranking.py
        
        echo "ğŸ“± Checking for X posts in build output..."
        if grep -q "X (Twitter)" index.html 2>/dev/null; then
          x_count=$(grep -c "X (Twitter)" index.html)
          echo "âœ… Found $x_count X posts in generated HTML"
        else
          echo "âš ï¸ No X posts found in generated HTML"
        fi

        echo "ğŸ“Š Verifying build output..."
        if [ -f "index.html" ]; then
          file_size=$(stat -c%s index.html)
          echo "âœ… index.html generated ($file_size bytes)"

          if [ "$file_size" -gt 10000 ]; then
            echo "âœ… Build verification passed"
          else
            echo "âš ï¸ Build file seems small but continuing..."
          fi
        else
          echo "âŒ index.html not generated!"
          exit 1
        fi

    - name: Deploy to GitHub Pages
      run: |
        echo "ğŸš€ Deploying to gh-pages branch..."
        
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Create .nojekyll file to disable Jekyll
        touch .nojekyll
        
        # Add generated files
        git add index.html style.css .nojekyll
        
        # Commit changes
        git commit -m "Deploy: AI News site update $(date '+%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
        
        # Force push to gh-pages branch
        git push origin HEAD:gh-pages --force
        
        echo "âœ… Deployment completed!"
        echo "ğŸŒ Site URL: https://awano27.github.io/daily-ai-news-pages/"

