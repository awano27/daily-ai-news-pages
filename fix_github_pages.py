#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Fix GitHub Pages - GitHub Pagesè¨­å®šã¨ãƒ“ãƒ«ãƒ‰ã®ç·Šæ€¥ä¿®æ­£
"""
import subprocess
import os
from datetime import datetime

def run_git_command(cmd, description):
    """Gitã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ"""
    print(f"ğŸ”„ {description}")
    try:
        result = subprocess.run(cmd, shell=True, capture_output=True, text=True, encoding='utf-8')
        if result.returncode == 0:
            print(f"âœ… {description} - æˆåŠŸ")
            if result.stdout.strip():
                print(f"   {result.stdout.strip()}")
            return True
        else:
            print(f"âŒ {description} - å¤±æ•—: {result.stderr}")
            return False
    except Exception as e:
        print(f"âŒ {description} - ã‚¨ãƒ©ãƒ¼: {e}")
        return False

def create_simple_index():
    """ã‚·ãƒ³ãƒ—ãƒ«ãªindex.htmlã‚’ä½œæˆ"""
    timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S JST')
    
    html_content = f"""<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Daily AI News - {timestamp}</title>
    <style>
        body {{ font-family: Arial, sans-serif; margin: 40px; }}
        .header {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                   color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }}
        .status {{ background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745; }}
        .info {{ background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 10px 0; }}
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸš€ Enhanced Daily AI News</h1>
        <p>Powered by Gemini URL Context API</p>
    </div>
    
    <div class="status">
        <h2>âœ… ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³</h2>
        <p><strong>æœ€çµ‚æ›´æ–°:</strong> {timestamp}</p>
        <p><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> Enhanced System ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†</p>
        <p><strong>Gemini API:</strong> çµ±åˆæ¸ˆã¿</p>
        <p><strong>XæŠ•ç¨¿å‡¦ç†:</strong> é‡è¤‡é™¤å»ãƒ»300æ–‡å­—è¦ç´„å¯¾å¿œ</p>
    </div>
    
    <div class="info">
        <h2>ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ æ©Ÿèƒ½</h2>
        <ul>
            <li>ğŸ§  <strong>Gemini URL Context</strong>: AI ã«ã‚ˆã‚‹é«˜åº¦ãªå†…å®¹åˆ†æ</li>
            <li>âŒ <strong>é‡è¤‡é™¤å»</strong>: ãƒãƒƒã‚·ãƒ¥ãƒ™ãƒ¼ã‚¹ + é¡ä¼¼åº¦åˆ†æ</li>  
            <li>ğŸ“ <strong>300æ–‡å­—è¦ç´„</strong>: èª­ã¿ã‚„ã™ã„ç°¡æ½”ãªè¦ç´„</li>
            <li>â­ <strong>é‡è¦åº¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°</strong>: AIåˆ¤å®šã«ã‚ˆã‚‹å„ªå…ˆè¡¨ç¤º</li>
            <li>ğŸ”„ <strong>è‡ªå‹•ã‚«ãƒ†ã‚´ãƒªåˆ†é¡</strong>: AIæŠ€è¡“/ãƒ“ã‚¸ãƒã‚¹/é–‹ç™ºãƒ„ãƒ¼ãƒ«</li>
            <li>ğŸ• <strong>è‡ªå‹•å®Ÿè¡Œ</strong>: æ¯æ—¥07:00ãƒ»19:00 JST</li>
        </ul>
    </div>
    
    <div class="info">
        <h2>ğŸ“Š GitHub Actions Status</h2>
        <p>GitHub Actions ã§ã®ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:</p>
        <ul>
            <li><a href="https://github.com/awano27/daily-ai-news-pages/actions" target="_blank">ğŸ”— GitHub Actions</a></li>
            <li><a href="https://github.com/awano27/daily-ai-news-pages/settings/pages" target="_blank">ğŸ”— Pages Settings</a></li>
            <li><a href="https://github.com/awano27/daily-ai-news-pages/settings/secrets/actions" target="_blank">ğŸ”— Secrets Settings</a></li>
        </ul>
    </div>
    
    <div class="info">
        <h2>ğŸš¨ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h2>
        <p>ã‚µã‚¤ãƒˆãŒè‡ªå‹•æ›´æ–°ã•ã‚Œãªã„å ´åˆã®ç¢ºèªäº‹é …:</p>
        <ol>
            <li><strong>GEMINI_API_KEY</strong> ãŒSecrets ã«æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹</li>
            <li><strong>GitHub Pages</strong> ãŒ main branch ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹</li>
            <li><strong>Workflow permissions</strong> ãŒ Read and write ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹</li>
            <li><strong>GitHub Actions</strong> ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹</li>
        </ol>
    </div>
    
    <div class="info">
        <h2>ğŸ“± æ¬¡å›æ›´æ–°äºˆå®š</h2>
        <p>æ¬¡å›ã®è‡ªå‹•æ›´æ–°ã¯ä»¥ä¸‹ã®æ™‚åˆ»ã§ã™:</p>
        <ul>
            <li>ğŸŒ… æ¯æ—¥ 07:00 JST</li>
            <li>ğŸŒ† æ¯æ—¥ 19:00 JST</li>
        </ul>
        <p><small>æ‰‹å‹•å®Ÿè¡Œã‚‚ GitHub Actions ã‹ã‚‰å¯èƒ½ã§ã™ã€‚</small></p>
    </div>
    
    <hr>
    <p><small>
        Generated by Enhanced AI News System v2.0<br>
        Last build: {timestamp}<br>
        <a href="https://github.com/awano27/daily-ai-news-pages">GitHub Repository</a>
    </small></p>
</body>
</html>"""
    
    try:
        with open("index.html", "w", encoding="utf-8") as f:
            f.write(html_content)
        print("âœ… ç·Šæ€¥ç”¨ index.html ã‚’ä½œæˆã—ã¾ã—ãŸ")
        return True
    except Exception as e:
        print(f"âŒ index.html ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
        return False

def create_github_pages_config():
    """GitHub Pagesç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ"""
    
    # .nojekyll ãƒ•ã‚¡ã‚¤ãƒ« (Jekyllç„¡åŠ¹åŒ–)
    try:
        with open(".nojekyll", "w") as f:
            f.write("# Disable Jekyll processing")
        print("âœ… .nojekyll ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ")
    except Exception as e:
        print(f"âŒ .nojekyll ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
    
    # CNAME ãƒ•ã‚¡ã‚¤ãƒ« (ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒã‚ã‚‹å ´åˆ)
    # ä»Šå›ã¯ä¸è¦ãªã®ã§ã‚¹ã‚­ãƒƒãƒ—

def create_minimal_workflow():
    """æœ€å°é™ã®å‹•ä½œã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ä½œæˆ"""
    workflow_content = """name: Minimal Build Test
on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          
      - name: Test build
        run: |
          echo "ğŸ§ª Minimal build test"
          echo "Current directory: $(pwd)"
          echo "Files in directory:"
          ls -la
          
          # æœ€å°é™ã®HTMLã‚’ç”Ÿæˆ
          cat > test_build.html << 'EOF'
<!DOCTYPE html>
<html>
<head><title>Build Test</title></head>
<body>
<h1>Build Test Success</h1>
<p>Generated at: $(date)</p>
</body>
</html>
EOF
          
          echo "âœ… Test HTML created"
          
      - name: Deploy
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add test_build.html || true
          git commit -m "ğŸ§ª Minimal build test $(date)" || echo "No changes"
          git push || echo "Push failed"
"""
    
    try:
        os.makedirs(".github/workflows", exist_ok=True)
        with open(".github/workflows/minimal-build.yml", "w", encoding="utf-8") as f:
            f.write(workflow_content)
        print("âœ… æœ€å°é™ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä½œæˆ")
        return True
    except Exception as e:
        print(f"âŒ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
        return False

def main():
    """ç·Šæ€¥ä¿®æ­£ã®å®Ÿè¡Œ"""
    print("ğŸš¨ GitHub Pages Emergency Fix")
    print("=" * 50)
    print(f"å®Ÿè¡Œæ™‚åˆ»: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print()
    
    # 1. ç·Šæ€¥ç”¨index.htmlä½œæˆ
    create_simple_index()
    
    # 2. GitHub Pagesè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
    create_github_pages_config() 
    
    # 3. æœ€å°é™ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä½œæˆ
    create_minimal_workflow()
    
    # 4. ã™ã¹ã¦ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
    print("\nğŸ“ ç·Šæ€¥ä¿®æ­£ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥:")
    
    commands = [
        ("git add index.html .nojekyll .github/workflows/minimal-build.yml", "ç·Šæ€¥ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°"),
        ("git commit -m \"ğŸš¨ Emergency fix: Add minimal index.html and workflow\"", "ç·Šæ€¥ä¿®æ­£ã‚’ã‚³ãƒŸãƒƒãƒˆ"),
        ("git push origin main", "ç·Šæ€¥ä¿®æ­£ã‚’ãƒ—ãƒƒã‚·ãƒ¥")
    ]
    
    for cmd, desc in commands:
        if not run_git_command(cmd, desc):
            print(f"âš ï¸ {desc} ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ç¶šè¡Œã—ã¾ã™")
    
    print("\n" + "=" * 50)
    print("ğŸ¯ ç·Šæ€¥ä¿®æ­£å®Œäº†!")
    print()
    print("ğŸ“‹ ç¢ºèªæ‰‹é †:")
    print("1. 5-10åˆ†å¾…ã£ã¦ã‹ã‚‰ã‚µã‚¤ãƒˆã‚’æ›´æ–°ã—ã¦ãã ã•ã„")
    print("2. GitHub Actions ã‚¿ãƒ–ã§å®Ÿè¡ŒçŠ¶æ³ã‚’ç¢ºèª")  
    print("3. Settings â†’ Pages ã§è¨­å®šã‚’ç¢ºèª")
    print("4. Settings â†’ Secrets â†’ Actions ã§ API key ã‚’ç¢ºèª")
    print()
    print("ğŸŒ ã‚µã‚¤ãƒˆURL: https://awano27.github.io/daily-ai-news-pages/")
    print()
    
    if os.path.exists("index.html"):
        print("âœ… index.html ãŒä½œæˆã•ã‚Œã¾ã—ãŸ")
        print("ğŸ“Š ã“ã®ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚Œã° GitHub Pages ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™")
    
    print("\nğŸ’¡ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:")
    print("- Enhanced Daily AI News ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå‹•ä½œã™ã‚‹ã‹ç¢ºèª")
    print("- ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ä¿®æ­£")
    print("- å…¨ä½“ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚Œã°å®šæœŸå®Ÿè¡ŒãŒé–‹å§‹ã•ã‚Œã¾ã™")

if __name__ == "__main__":
    main()
    input("Press Enter to exit...")