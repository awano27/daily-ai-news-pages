name: Deploy AI News to GitHub Pages

on:
  push:
    branches: [ main ]
  schedule:
    # Run daily at 7:00 JST (22:00 UTC)
    - cron: '0 22 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt || pip install feedparser pyyaml deep-translator==1.11.4 beautifulsoup4 requests google-generativeai>=0.3.0

    - name: Set environment variables
      run: |
        echo "TRANSLATE_TO_JA=1" >> $GITHUB_ENV
        echo "TRANSLATE_ENGINE=google" >> $GITHUB_ENV
        echo "HOURS_LOOKBACK=24" >> $GITHUB_ENV
        echo "MAX_ITEMS_PER_CATEGORY=25" >> $GITHUB_ENV

    - name: Build AI News Site
      timeout-minutes: 10
      run: |
        echo "ğŸ”¨ Building AI News site with enhanced ranking..."
        python build_simple_ranking.py

        echo "ğŸ“Š Verifying build output..."
        if [ -f "index.html" ]; then
          file_size=$(stat -c%s index.html)
          echo "âœ… index.html generated ($file_size bytes)"

          if [ "$file_size" -gt 10000 ]; then
            echo "âœ… Build verification passed"
          else
            echo "âš ï¸ Build file seems small but continuing..."
          fi
        else
          echo "âŒ index.html not generated!"
          exit 1
        fi

    - name: Prepare Pages artifact
      run: |
        echo "ğŸ“¦ Preparing Pages artifact (_site)"
        rm -rf _site || true
        mkdir -p _site
        cp -v index.html _site/
        cp -v style.css _site/ || true
        # Disable Jekyll on Pages
        touch _site/.nojekyll
        ls -la _site

    - name: Setup Pages
      uses: actions/configure-pages@v5

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '_site'

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Display results
      run: |
        echo "ğŸ‰ Deployment completed!"
        echo "ğŸŒ Site URL: ${{ steps.deployment.outputs.page_url }}"
        echo "ğŸ“… Expected: Current date with enhanced features"
        echo "ğŸ–±ï¸ Expected: Working tab functionality"

