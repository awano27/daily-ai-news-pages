name: Deploy to Public Pages Repo

on:
  # æ‰‹å‹•å®Ÿè¡Œã¨ãƒ“ãƒ«ãƒ‰æˆåŠŸå¾Œã®è‡ªå‹•å®Ÿè¡Œ
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'index.html'
      - 'dashboard.html'
      - '**.html'
  workflow_run:
    workflows: ["Daily build (JA summaries fixed)"]
    types:
      - completed

jobs:
  deploy-to-public:
    runs-on: ubuntu-latest
    # Daily buildãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œï¼ˆæ‰‹å‹•å®Ÿè¡Œã¯å¸¸ã«å®Ÿè¡Œï¼‰
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git config
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Create outputs directory
        run: |
          mkdir -p outputs
          
      - name: Copy built files to outputs
        run: |
          # HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
          cp -f index.html outputs/ 2>/dev/null || true
          cp -f dashboard.html outputs/ 2>/dev/null || true
          
          # å¿…è¦ãªé™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆã‚ã‚Œã°ï¼‰
          [ -d "assets" ] && cp -r assets outputs/ || true
          [ -d "css" ] && cp -r css outputs/ || true
          [ -d "js" ] && cp -r js outputs/ || true
          [ -f ".nojekyll" ] && cp .nojekyll outputs/ || true
          
          # ãƒ‡ãƒãƒƒã‚°: outputsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹ã‚’ç¢ºèª
          echo "ğŸ“ Contents of outputs directory:"
          ls -la outputs/

      - name: Check if index.html exists
        run: |
          if [ ! -f "outputs/index.html" ]; then
            echo "âš ï¸ Warning: index.html not found in outputs directory"
            echo "Creating placeholder index.html..."
            echo '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>AI News Dashboard</title></head><body><h1>AI News Dashboard - Building...</h1><p>The dashboard is currently being generated. Please check back later.</p></body></html>' > outputs/index.html
          fi

      - name: Deploy to public repository
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ secrets.PERSONAL_TOKEN }}
          external_repository: awano27/daily-ai-news-pages
          publish_branch: gh-pages
          publish_dir: ./outputs
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy from private repo: ${{ github.sha }}'
          force_orphan: false
          keep_files: false
          enable_jekyll: false

      - name: Verify deployment
        run: |
          echo "âœ… Deployment completed!"
          echo "ğŸ“ Public site will be available at: https://awano27.github.io/daily-ai-news-pages/"
          echo "ğŸ”— Public repository: https://github.com/awano27/daily-ai-news-pages"